<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>库存管理系统</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
        }
        
        .tabs {
            display: flex;
            overflow-x: auto;
            background-color: #fff;
            border-radius: 8px 8px 0 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }
        
        .tab.active {
            border-bottom-color: #3498db;
            color: #3498db;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
            background-color: #fff;
            padding: 20px;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        button.secondary {
            background-color: #95a5a6;
        }
        
        button.secondary:hover {
            background-color: #7f8c8d;
        }
        
        button.danger {
            background-color: #e74c3c;
        }
        
        button.danger:hover {
            background-color: #c0392b;
        }
        
        .table-container {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
        
        .stats-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            flex: 1;
            min-width: 150px;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
        }
        
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        
        .filter-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-container input,
        .filter-container select {
            flex: 1;
            min-width: 150px;
        }
        
        .confirm-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            max-width: 400px;
            width: 90%;
        }
        
        .confirm-dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 999;
        }
        
        .edit-input {
            width: 80px;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: right;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .date-input-group {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        .inventory-notice {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 4px;
            margin-top: 5px;
            font-size: 14px;
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            .stats-container {
                flex-direction: column;
            }
            
            .stat-card {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>库存管理系统</h1>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('inventory')">当前库存</div>
            <div class="tab" onclick="switchTab('inbound')">物品入库</div>
            <div class="tab" onclick="switchTab('outbound')">物品出库</div>
            <div class="tab" onclick="switchTab('records')">出入库记录</div>
            <div class="tab" onclick="switchTab('sell')">物品售卖</div>
            <div class="tab" onclick="switchTab('sellRecords')">售卖记录</div>
            <div class="tab" onclick="switchTab('sync')">数据同步</div>
        </div>
        
        <!-- 当前库存 -->
        <div id="inventory" class="tab-content active">
            <div class="filter-container">
                <input type="text" id="inventory-search" placeholder="搜索物品..." oninput="filterInventory()">
            </div>
            <div class="table-container">
                <table id="inventory-table">
                    <thead>
                        <tr>
                            <th>物品名称</th>
                            <th>数量</th>
                            <th>单位</th>
                            <th>最近更新</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-body"></tbody>
                </table>
            </div>
        </div>
        
        <!-- 物品入库 -->
        <div id="inbound" class="tab-content">
            <div class="form-group">
                <label for="inbound-name">物品名称</label>
                <input type="text" id="inbound-name" placeholder="输入物品名称">
            </div>
            <div class="form-group">
                <label for="inbound-quantity">数量</label>
                <input type="number" id="inbound-quantity" placeholder="输入数量" min="1" value="1">
            </div>
            <div class="form-group">
                <label for="inbound-unit">单位</label>
                <input type="text" id="inbound-unit" placeholder="输入单位" value="个">
            </div>
            <button onclick="addInboundItem()">确认入库</button>
        </div>
        
        <!-- 物品出库 -->
        <div id="outbound" class="tab-content">
            <div class="form-group">
                <label for="outbound-name">物品名称</label>
                <input type="text" id="outbound-name" placeholder="输入物品名称">
            </div>
            <div class="form-group">
                <label for="outbound-quantity">数量</label>
                <input type="number" id="outbound-quantity" placeholder="输入数量" min="1" value="1">
            </div>
            <button onclick="addOutboundItem()">确认出库</button>
        </div>
        
        <!-- 出入库记录 -->
        <div id="records" class="tab-content">
            <div class="filter-container">
                <input type="date" id="records-date" placeholder="选择日期">
                <select id="records-type">
                    <option value="all">全部类型</option>
                    <option value="inbound">入库</option>
                    <option value="outbound">出库</option>
                </select>
                <button onclick="filterRecords()">筛选</button>
                <button class="secondary" onclick="resetRecordFilter()">重置</button>
            </div>
            <div class="table-container">
                <table id="records-table">
                    <thead>
                        <tr>
                            <th>物品名称</th>
                            <th>数量</th>
                            <th>单位</th>
                            <th>类型</th>
                            <th>日期</th>
                            <th>备注</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="records-body"></tbody>
                </table>
            </div>
        </div>
        
        <!-- 物品售卖 -->
        <div id="sell" class="tab-content">
            <div class="form-group">
                <label for="sell-item-select">从库存选择物品（可选）</label>
                <select id="sell-item-select">
                    <option value="">请选择库存物品</option>
                </select>
                <div id="item-inventory-info" class="inventory-notice" style="display: none;"></div>
            </div>
            <div class="form-group">
                <label for="sell-name">物品名称（如不选择库存物品，请手动输入）</label>
                <input type="text" id="sell-name" placeholder="输入物品名称">
            </div>
            <div class="form-group">
                <label for="sell-quantity">数量</label>
                <input type="number" id="sell-quantity" placeholder="输入数量" min="1" value="1">
            </div>
            <div class="form-group">
                <label for="sell-original-price">原价（元）</label>
                <input type="number" id="sell-original-price" placeholder="输入原价" min="0" step="0.01" value="0">
            </div>
            <div class="form-group">
                <label for="sell-price">售卖单价（元）</label>
                <input type="number" id="sell-price" placeholder="输入售卖单价" min="0" step="0.01" value="0">
            </div>
            <button onclick="addSellItem()">确认售卖</button>
        </div>
        
        <!-- 售卖记录 -->
        <div id="sellRecords" class="tab-content">
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-value" id="total-sales-quantity">0</div>
                    <div class="stat-label">总销量</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-original-price">¥0.00</div>
                    <div class="stat-label">总价（原价）</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-sales-amount">¥0.00</div>
                    <div class="stat-label">总销售额</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-profit">¥0.00</div>
                    <div class="stat-label">盈利</div>
                </div>
            </div>
            <div class="filter-container">
                <input type="date" id="sell-date" placeholder="选择日期">
                <button onclick="filterSellRecords()">筛选</button>
                <button class="secondary" onclick="resetSellFilter()">重置</button>
            </div>
            <div class="table-container">
                <table id="sell-records-table">
                    <thead>
                        <tr>
                            <th>物品名称</th>
                            <th>数量</th>
                            <th>原价（元）</th>
                            <th>现价（元）</th>
                            <th>日期</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="sell-records-body"></tbody>
                </table>
            </div>
        </div>
        
        <!-- 数据同步 -->
        <div id="sync" class="tab-content">
            <div class="form-group">
                <label>导出数据</label>
                <button onclick="exportData()">导出数据</button>
            </div>
            <div class="form-group">
                <label for="import-data">导入数据</label>
                <input type="file" id="import-data" accept=".json">
                <button onclick="importData()">确认导入</button>
            </div>
            <div class="form-group">
                <label>生成分享二维码</label>
                <button onclick="generateQRCode()">生成二维码</button>
                <div id="qrcode-container" style="margin-top: 20px; text-align: center;"></div>
            </div>
        </div>
    </div>
    
    <!-- 确认对话框 -->
    <div id="confirm-dialog" class="confirm-dialog" style="display: none;">
        <h3 id="confirm-title">确认操作</h3>
        <p id="confirm-message">确定要执行此操作吗？</p>
        <div class="confirm-options" style="margin: 15px 0;">
            <label><input type="checkbox" id="restore-inventory"> 同时恢复相关库存</label>
        </div>
        <div class="modal-footer">
            <button onclick="closeConfirmDialog()">取消</button>
            <button id="confirm-button" class="danger">确认</button>
        </div>
    </div>
    <div id="confirm-overlay" class="confirm-dialog-overlay" style="display: none;"></div>
    
    <script>
        // 确保所有函数挂载在window对象上，以兼容微信环境
        (function() {
            // 数据存储对象
            let inventory = {};
            let records = [];
            let sellRecords = [];
            
            // 初始化数据
            window.initData = function() {
                try {
                    // 尝试从localStorage加载数据
                    const savedInventory = localStorage.getItem('inventory');
                    const savedRecords = localStorage.getItem('records');
                    const savedSellRecords = localStorage.getItem('sellRecords');
                    
                    if (savedInventory) inventory = JSON.parse(savedInventory);
                    if (savedRecords) records = JSON.parse(savedRecords);
                    if (savedSellRecords) sellRecords = JSON.parse(savedSellRecords);
                } catch (e) {
                    console.error('加载数据失败，使用空数据', e);
                    // 降级为内存存储
                    inventory = {};
                    records = [];
                    sellRecords = [];
                }
                
                // 更新界面
                updateInventoryTable();
                updateRecordsTable();
                updateSellRecordsTable();
                updateInventorySelect();
            };
            
            // 保存数据
            window.saveData = function() {
                try {
                    localStorage.setItem('inventory', JSON.stringify(inventory));
                    localStorage.setItem('records', JSON.stringify(records));
                    localStorage.setItem('sellRecords', JSON.stringify(sellRecords));
                } catch (e) {
                    console.error('保存数据失败', e);
                    // 继续运行，使用内存存储
                }
            };
            
            // 切换标签
            window.switchTab = function(tabId) {
                // 隐藏所有内容
                const contents = document.querySelectorAll('.tab-content');
                contents.forEach(content => content.classList.remove('active'));
                
                // 移除所有标签的激活状态
                const tabs = document.querySelectorAll('.tab');
                tabs.forEach(tab => tab.classList.remove('active'));
                
                // 显示选中的内容和标签
                document.getElementById(tabId).classList.add('active');
                event.target.classList.add('active');
                
                // 更新各标签页的数据
                if (tabId === 'inventory') updateInventoryTable();
                if (tabId === 'records') updateRecordsTable();
                if (tabId === 'sellRecords') updateSellRecordsTable();
                if (tabId === 'sell') updateInventorySelect();
            };
            
            // 更新库存选择下拉框
            window.updateInventorySelect = function() {
                const select = document.getElementById('sell-item-select');
                // 保留第一个空选项
                select.innerHTML = '<option value="">请选择库存物品</option>';
                
                Object.keys(inventory).forEach(name => {
                    const item = inventory[name];
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = `${name} (${item.quantity} ${item.unit})`;
                    select.appendChild(option);
                });
                
                // 重置选择事件
                select.onchange = function() {
                    const selectedName = this.value;
                    const nameInput = document.getElementById('sell-name');
                    const inventoryInfo = document.getElementById('item-inventory-info');
                    
                    if (selectedName) {
                        nameInput.value = selectedName;
                        const item = inventory[selectedName];
                        inventoryInfo.textContent = `当前库存：${item.quantity} ${item.unit}`;
                        inventoryInfo.style.display = 'block';
                    } else {
                        nameInput.value = '';
                        inventoryInfo.style.display = 'none';
                    }
                };
            };
            
            // 添加入库物品
            window.addInboundItem = function() {
                const name = document.getElementById('inbound-name').value.trim();
                const quantity = parseInt(document.getElementById('inbound-quantity').value);
                const unit = document.getElementById('inbound-unit').value.trim();
                
                if (!name || isNaN(quantity) || quantity <= 0) {
                    alert('请填写正确的物品信息');
                    return;
                }
                
                const now = new Date();
                const dateStr = now.toISOString().split('T')[0];
                
                // 更新库存
                if (!inventory[name]) {
                    inventory[name] = {
                        quantity: 0,
                        unit: unit || '个',
                        lastUpdated: dateStr
                    };
                }
                
                inventory[name].quantity += quantity;
                inventory[name].lastUpdated = dateStr;
                
                // 添加记录
                records.push({
                    id: Date.now(),
                    name: name,
                    quantity: quantity,
                    unit: inventory[name].unit,
                    type: 'inbound',
                    date: dateStr,
                    timestamp: now.getTime(),
                    remark: ''
                });
                
                // 保存数据
                saveData();
                
                // 更新界面
                updateInventoryTable();
                updateRecordsTable();
                updateInventorySelect();
                
                // 清空表单
                document.getElementById('inbound-name').value = '';
                document.getElementById('inbound-quantity').value = '1';
                document.getElementById('inbound-unit').value = '个';
                
                alert('物品入库成功');
            };
            
            // 添加出库物品
            window.addOutboundItem = function() {
                const name = document.getElementById('outbound-name').value.trim();
                const quantity = parseInt(document.getElementById('outbound-quantity').value);
                
                if (!name || isNaN(quantity) || quantity <= 0) {
                    alert('请填写正确的物品信息');
                    return;
                }
                
                // 检查库存
                if (!inventory[name] || inventory[name].quantity < quantity) {
                    alert('库存不足');
                    return;
                }
                
                const now = new Date();
                const dateStr = now.toISOString().split('T')[0];
                
                // 更新库存
                inventory[name].quantity -= quantity;
                inventory[name].lastUpdated = dateStr;
                
                // 添加记录
                records.push({
                    id: Date.now(),
                    name: name,
                    quantity: quantity,
                    unit: inventory[name].unit,
                    type: 'outbound',
                    date: dateStr,
                    timestamp: now.getTime(),
                    remark: ''
                });
                
                // 保存数据
                saveData();
                
                // 更新界面
                updateInventoryTable();
                updateRecordsTable();
                updateInventorySelect();
                
                // 清空表单
                document.getElementById('outbound-name').value = '';
                document.getElementById('outbound-quantity').value = '1';
                
                alert('物品出库成功');
            };
            
            // 添加售卖物品（如果是库存物品，自动生成出库记录）
            window.addSellItem = function() {
                const selectedItem = document.getElementById('sell-item-select').value;
                const name = document.getElementById('sell-name').value.trim();
                const quantity = parseInt(document.getElementById('sell-quantity').value);
                const originalPrice = parseFloat(document.getElementById('sell-original-price').value);
                const price = parseFloat(document.getElementById('sell-price').value);
                
                if (!name || isNaN(quantity) || quantity <= 0 || isNaN(originalPrice) || isNaN(price) || originalPrice < 0 || price < 0) {
                    alert('请填写正确的售卖信息');
                    return;
                }
                
                const now = new Date();
                const dateStr = now.toISOString().split('T')[0];
                let unit = '个';
                let isInventoryItem = false;
                
                // 检查是否是库存中的物品
                if (inventory[name]) {
                    isInventoryItem = true;
                    unit = inventory[name].unit;
                    
                    // 检查库存是否足够
                    if (inventory[name].quantity < quantity) {
                        alert('库存不足，无法完成售卖');
                        return;
                    }
                    
                    // 更新库存
                    inventory[name].quantity -= quantity;
                    inventory[name].lastUpdated = dateStr;
                    
                    // 添加出库记录
                    records.push({
                        id: Date.now(),
                        name: name,
                        quantity: quantity,
                        unit: unit,
                        type: 'outbound',
                        date: dateStr,
                        timestamp: now.getTime(),
                        remark: '售卖出库'
                    });
                }
                
                // 添加售卖记录
                sellRecords.push({
                    id: Date.now(),
                    name: name,
                    quantity: quantity,
                    originalPrice: originalPrice,
                    price: price,
                    date: dateStr,
                    timestamp: now.getTime(),
                    isInventoryItem: isInventoryItem,
                    unit: unit
                });
                
                // 保存数据
                saveData();
                
                // 更新界面
                updateInventoryTable();
                updateRecordsTable();
                updateSellRecordsTable();
                updateInventorySelect();
                
                // 清空表单
                document.getElementById('sell-item-select').value = '';
                document.getElementById('sell-name').value = '';
                document.getElementById('sell-quantity').value = '1';
                document.getElementById('sell-original-price').value = '0';
                document.getElementById('sell-price').value = '0';
                document.getElementById('item-inventory-info').style.display = 'none';
                
                alert(isInventoryItem ? '售卖成功，已自动更新库存' : '售卖记录添加成功');
            };
            
            // 更新库存表格
            window.updateInventoryTable = function() {
                const tbody = document.getElementById('inventory-body');
                tbody.innerHTML = '';
                
                const searchTerm = document.getElementById('inventory-search')?.value.toLowerCase() || '';
                
                Object.keys(inventory).forEach(name => {
                    if (name.toLowerCase().includes(searchTerm)) {
                        const item = inventory[name];
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${name}</td>
                            <td>${item.quantity}</td>
                            <td>${item.unit}</td>
                            <td>${item.lastUpdated}</td>
                        `;
                        tbody.appendChild(row);
                    }
                });
            };
            
            // 筛选库存
            window.filterInventory = function() {
                updateInventoryTable();
            };
            
            // 更新记录表格
            window.updateRecordsTable = function() {
                const tbody = document.getElementById('records-body');
                tbody.innerHTML = '';
                
                const dateFilter = document.getElementById('records-date').value;
                const typeFilter = document.getElementById('records-type').value;
                
                let filteredRecords = records;
                
                if (dateFilter) {
                    filteredRecords = filteredRecords.filter(record => record.date === dateFilter);
                }
                
                if (typeFilter !== 'all') {
                    filteredRecords = filteredRecords.filter(record => record.type === typeFilter);
                }
                
                // 按时间倒序排列
                filteredRecords.sort((a, b) => b.timestamp - a.timestamp);
                
                filteredRecords.forEach(record => {
                    const row = document.createElement('tr');
                    const typeText = record.type === 'inbound' ? '入库' : '出库';
                    const typeClass = record.type === 'inbound' ? 'color: green;' : 'color: red;';
                    const remark = record.remark || '';
                    
                    row.innerHTML = `
                        <td>${record.name}</td>
                        <td style="${typeClass}">${record.type === 'inbound' ? '+' : '-' }${record.quantity}</td>
                        <td>${record.unit}</td>
                        <td>${typeText}</td>
                        <td>${record.date}</td>
                        <td>${remark}</td>
                        <td>
                            <button class="danger" onclick="deleteRecord(${record.id})">删除</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            };
            
            // 筛选记录
            window.filterRecords = function() {
                updateRecordsTable();
            };
            
            // 重置记录筛选
            window.resetRecordFilter = function() {
                document.getElementById('records-date').value = '';
                document.getElementById('records-type').value = 'all';
                updateRecordsTable();
            };
            
            // 更新售卖记录表格
            window.updateSellRecordsTable = function() {
                const tbody = document.getElementById('sell-records-body');
                tbody.innerHTML = '';
                
                const dateFilter = document.getElementById('sell-date').value;
                
                let filteredRecords = sellRecords;
                
                if (dateFilter) {
                    filteredRecords = filteredRecords.filter(record => record.date === dateFilter);
                }
                
                // 按时间倒序排列
                filteredRecords.sort((a, b) => b.timestamp - a.timestamp);
                
                // 计算统计数据
                let totalQuantity = 0;
                let totalOriginalPrice = 0;
                let totalSalesAmount = 0;
                
                filteredRecords.forEach(record => {
                    totalQuantity += record.quantity;
                    totalOriginalPrice += record.originalPrice * record.quantity;
                    totalSalesAmount += record.price * record.quantity;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${record.name}</td>
                        <td>${record.quantity}</td>
                        <td>
                            <input type="number" class="edit-input" value="${record.originalPrice.toFixed(2)}" 
                                   onchange="updateSellOriginalPrice(${record.id}, this.value)" min="0" step="0.01">
                        </td>
                        <td>
                            <input type="number" class="edit-input" value="${record.price.toFixed(2)}" 
                                   onchange="updateSellPrice(${record.id}, this.value)" min="0" step="0.01">
                        </td>
                        <td>${record.date}</td>
                        <td>
                            <button class="danger" onclick="deleteSellRecord(${record.id})">删除</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                // 更新统计数据显示
                document.getElementById('total-sales-quantity').textContent = totalQuantity;
                document.getElementById('total-original-price').textContent = `¥${totalOriginalPrice.toFixed(2)}`;
                document.getElementById('total-sales-amount').textContent = `¥${totalSalesAmount.toFixed(2)}`;
                document.getElementById('total-profit').textContent = `¥${(totalSalesAmount - totalOriginalPrice).toFixed(2)}`;
            };
            
            // 筛选售卖记录
            window.filterSellRecords = function() {
                updateSellRecordsTable();
            };
            
            // 重置售卖记录筛选
            window.resetSellFilter = function() {
                document.getElementById('sell-date').value = '';
                updateSellRecordsTable();
            };
            
            // 更新售卖记录原价
            window.updateSellOriginalPrice = function(recordId, newPrice) {
                const price = parseFloat(newPrice);
                if (isNaN(price) || price < 0) {
                    alert('请输入有效的价格');
                    updateSellRecordsTable();
                    return;
                }
                
                const record = sellRecords.find(r => r.id === recordId);
                if (record) {
                    record.originalPrice = price;
                    saveData();
                    updateSellRecordsTable();
                }
            };
            
            // 更新售卖记录现价
            window.updateSellPrice = function(recordId, newPrice) {
                const price = parseFloat(newPrice);
                if (isNaN(price) || price < 0) {
                    alert('请输入有效的价格');
                    updateSellRecordsTable();
                    return;
                }
                
                const record = sellRecords.find(r => r.id === recordId);
                if (record) {
                    record.price = price;
                    saveData();
                    updateSellRecordsTable();
                }
            };
            
            // 显示确认对话框
            let confirmCallback = null;
            window.showConfirmDialog = function(title, message, showRestoreOption = false, callback) {
                document.getElementById('confirm-title').textContent = title;
                document.getElementById('confirm-message').textContent = message;
                document.getElementById('restore-inventory').parentElement.style.display = showRestoreOption ? 'block' : 'none';
                document.getElementById('restore-inventory').checked = showRestoreOption;
                confirmCallback = callback;
                
                document.getElementById('confirm-dialog').style.display = 'block';
                document.getElementById('confirm-overlay').style.display = 'block';
            };
            
            // 关闭确认对话框
            window.closeConfirmDialog = function() {
                document.getElementById('confirm-dialog').style.display = 'none';
                document.getElementById('confirm-overlay').style.display = 'none';
                confirmCallback = null;
            };
            
            // 确认操作
            window.confirmOperation = function() {
                if (confirmCallback) {
                    const restoreInventory = document.getElementById('restore-inventory').checked;
                    confirmCallback(restoreInventory);
                }
                closeConfirmDialog();
            };
            
            // 删除记录
            window.deleteRecord = function(recordId) {
                const record = records.find(r => r.id === recordId);
                if (!record) return;
                
                showConfirmDialog(
                    '删除记录',
                    `确定要删除「${record.name}」的${record.type === 'inbound' ? '入库' : '出库'}记录吗？`,
                    true,
                    function(restoreInventory) {
                        // 删除记录
                        records = records.filter(r => r.id !== recordId);
                        
                        // 如果选择恢复库存
                        if (restoreInventory) {
                            if (!inventory[record.name]) {
                                inventory[record.name] = {
                                    quantity: 0,
                                    unit: record.unit,
                                    lastUpdated: new Date().toISOString().split('T')[0]
                                };
                            }
                            
                            if (record.type === 'inbound') {
                                // 恢复入库记录：减少库存
                                inventory[record.name].quantity = Math.max(0, inventory[record.name].quantity - record.quantity);
                            } else {
                                // 恢复出库记录：增加库存
                                inventory[record.name].quantity += record.quantity;
                            }
                            
                            inventory[record.name].lastUpdated = new Date().toISOString().split('T')[0];
                        }
                        
                        // 保存数据
                        saveData();
                        
                        // 更新界面
                        updateInventoryTable();
                        updateRecordsTable();
                        updateInventorySelect();
                        
                        alert('记录删除成功' + (restoreInventory ? '，库存已恢复' : ''));
                    }
                );
            };
            
            // 删除售卖记录
            window.deleteSellRecord = function(recordId) {
                const record = sellRecords.find(r => r.id === recordId);
                if (!record) return;
                
                let message = '确定要删除这条售卖记录吗？';
                let showRestoreOption = false;
                
                // 如果是库存物品的售卖记录，提供恢复库存选项
                if (record.isInventoryItem) {
                    message = '确定要删除这条售卖记录吗？如果这条记录对应了出库操作，您可以选择是否恢复相关库存。';
                    showRestoreOption = true;
                }
                
                showConfirmDialog(
                    '删除售卖记录',
                    message,
                    showRestoreOption,
                    function(restoreInventory) {
                        // 如果需要恢复库存且是库存物品的售卖记录
                        if (restoreInventory && record.isInventoryItem) {
                            // 查找对应的出库记录（通过时间和名称匹配）
                            const relatedOutboundRecords = records.filter(r => 
                                r.type === 'outbound' && 
                                r.name === record.name && 
                                r.date === record.date && 
                                r.remark === '售卖出库' && 
                                Math.abs(r.timestamp - record.timestamp) < 1000 // 时间相差1秒内的记录
                            );
                            
                            // 更新库存
                            if (!inventory[record.name]) {
                                inventory[record.name] = {
                                    quantity: 0,
                                    unit: record.unit,
                                    lastUpdated: new Date().toISOString().split('T')[0]
                                };
                            }
                            inventory[record.name].quantity += record.quantity;
                            inventory[record.name].lastUpdated = new Date().toISOString().split('T')[0];
                            
                            // 删除相关的出库记录
                            records = records.filter(r => !relatedOutboundRecords.some(or => or.id === r.id));
                        }
                        
                        // 删除售卖记录
                        sellRecords = sellRecords.filter(r => r.id !== recordId);
                        
                        // 保存数据
                        saveData();
                        
                        // 更新界面
                        updateInventoryTable();
                        updateRecordsTable();
                        updateSellRecordsTable();
                        updateInventorySelect();
                        
                        alert('售卖记录删除成功' + (restoreInventory && record.isInventoryItem ? '，库存已恢复' : ''));
                    }
                );
            };
            
            // 导出数据
            window.exportData = function() {
                const data = {
                    inventory: inventory,
                    records: records,
                    sellRecords: sellRecords,
                    exportDate: new Date().toISOString()
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `inventory-data-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };
            
            // 导入数据
            window.importData = function() {
                const fileInput = document.getElementById('import-data');
                if (!fileInput.files || !fileInput.files[0]) {
                    alert('请选择要导入的文件');
                    return;
                }
                
                const file = fileInput.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        // 验证数据格式
                        if (data.inventory && data.records && data.sellRecords) {
                            showConfirmDialog(
                                '导入数据',
                                '导入数据将覆盖现有数据，确定要继续吗？',
                                false,
                                function() {
                                    inventory = data.inventory;
                                    records = data.records;
                                    sellRecords = data.sellRecords;
                                    
                                    // 保存数据
                                    saveData();
                                    
                                    // 更新界面
                                    updateInventoryTable();
                                    updateRecordsTable();
                                    updateSellRecordsTable();
                                    updateInventorySelect();
                                    
                                    alert('数据导入成功');
                                    // 清空文件输入
                                    fileInput.value = '';
                                }
                            );
                        } else {
                            alert('无效的数据文件格式');
                        }
                    } catch (e) {
                        alert('导入失败，请检查文件格式');
                    }
                };
                
                reader.readAsText(file);
            };
            
            // 生成二维码
            window.generateQRCode = function() {
                // 创建数据URL
                const data = {
                    inventory: inventory,
                    records: records,
                    sellRecords: sellRecords,
                    exportDate: new Date().toISOString()
                };
                
                const dataStr = JSON.stringify(data);
                const dataUrl = 'data:text/json;charset=utf-8,' + encodeURIComponent(dataStr);
                
                // 创建二维码（简化实现，实际使用可以引入二维码库）
                const container = document.getElementById('qrcode-container');
                container.innerHTML = `
                    <p>请扫描下方二维码分享数据</p>
                    <p>（提示：由于浏览器限制，这里显示为文本链接，请复制后在其他设备打开）</p>
                    <textarea style="width: 100%; height: 100px;" readonly>${dataUrl}</textarea>
                    <button onclick="copyToClipboard()">复制链接</button>
                `;
            };
            
            // 复制到剪贴板
            window.copyToClipboard = function() {
                const textarea = document.querySelector('#qrcode-container textarea');
                textarea.select();
                document.execCommand('copy');
                alert('链接已复制到剪贴板');
            };
            
            // 页面加载完成后初始化
            document.addEventListener('DOMContentLoaded', function() {
                // 绑定确认按钮事件
                document.getElementById('confirm-button').onclick = confirmOperation;
                
                // 初始化数据
                initData();
            });
        })();
    </script>
</body>
</html>