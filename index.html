<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>库存管理系统</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            padding: 10px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 24px;
            color: #333;
        }
        
        .tab-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .tab-container:nth-child(3) {
            grid-template-columns: repeat(3, 1fr);
        }
        
        .tab {
            padding: 12px 10px;
            background-color: #e0e0e0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        
        .tab.active {
            background-color: #1aad19;
            color: white;
        }
        
        .panel {
            display: none;
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .panel.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 14px;
        }
        
        input[type="text"],
        input[type="number"],
        input[type="date"],
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        button {
            background-color: #1aad19;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-top: 10px;
        }
        
        button:hover {
            background-color: #198717;
        }
        
        button.secondary {
            background-color: #f8f8f8;
            color: #333;
            border: 1px solid #ddd;
        }
        
        button.danger {
            background-color: #e74c3c;
        }
        
        button.warning {
            background-color: #f39c12;
        }
        
        .table-container {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background-color: #f9f9f9;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .item-actions {
            display: flex;
            gap: 5px;
        }
        
        .item-actions button {
            padding: 5px 10px;
            font-size: 12px;
            width: auto;
            margin: 0;
        }
        
        .message {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 6px;
            display: none;
        }
        
        .message.success {
            background-color: #d4edda;
            color: #155724;
            display: block;
        }
        
        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            display: block;
        }
        
        .quantity-input {
            width: 80px;
            padding: 5px;
            text-align: center;
        }
        
        .price-input {
            width: 80px;
            padding: 5px;
            text-align: center;
        }
        
        .qr-code-container {
            text-align: center;
            margin: 20px 0;
        }
        
        .qr-code-container img {
            max-width: 100%;
            height: auto;
        }
        
        .import-export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .import-export-buttons button {
            flex: 1;
            margin-top: 0;
        }
        
        .total-stats {
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 6px;
            margin-top: 15px;
            font-size: 14px;
        }
        
        .total-stats p {
            margin: 5px 0;
        }
        
        .profit {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .loss {
            color: #16a085;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>库存管理系统</h1>
    
    <div class="tab-container">
        <div class="tab active" onclick="switchTab('inventory')">当前库存</div>
        <div class="tab" onclick="switchTab('import')">物品入库</div>
        <div class="tab" onclick="switchTab('export')">物品出库</div>
        <div class="tab" onclick="switchTab('records')">出入库记录</div>
    </div>
    
    <div class="tab-container">
        <div class="tab" onclick="switchTab('sell')">物品售卖</div>
        <div class="tab" onclick="switchTab('sellRecords')">售卖记录</div>
        <div class="tab" onclick="switchTab('sync')">数据同步</div>
    </div>
    
    <div id="inventoryPanel" class="panel active">
        <div class="message" id="inventoryMessage"></div>
        <div class="total-stats">
            <p>库存物品总数: <span id="totalItems">0</span></p>
            <p>库存总价值: ¥<span id="totalValue">0.00</span></p>
        </div>
        <div class="table-container">
            <table id="inventoryTable">
                <thead>
                    <tr>
                        <th>物品名称</th>
                        <th>数量</th>
                        <th>单价</th>
                        <th>总价</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    
    <div id="importPanel" class="panel">
        <div class="message" id="importMessage"></div>
        <div class="form-group">
            <label for="importName">物品名称</label>
            <input type="text" id="importName" placeholder="请输入物品名称">
        </div>
        <div class="form-group">
            <label for="importQuantity">数量</label>
            <input type="number" id="importQuantity" min="1" placeholder="请输入数量">
        </div>
        <div class="form-group">
            <label for="importPrice">单价 (¥)</label>
            <input type="number" id="importPrice" min="0" step="0.01" placeholder="请输入单价">
        </div>
        <button onclick="addInventoryItem()">确认入库</button>
    </div>
    
    <div id="exportPanel" class="panel">
        <div class="message" id="exportMessage"></div>
        <div class="form-group">
            <label for="exportName">物品名称</label>
            <select id="exportName"></select>
        </div>
        <div class="form-group">
            <label for="exportQuantity">数量</label>
            <input type="number" id="exportQuantity" min="1" placeholder="请输入数量">
        </div>
        <button onclick="removeInventoryItem()">确认出库</button>
    </div>
    
    <div id="recordsPanel" class="panel">
        <div class="message" id="recordsMessage"></div>
        <div class="form-group">
            <label for="recordDate">筛选日期</label>
            <input type="date" id="recordDate">
        </div>
        <button onclick="filterRecords()">筛选</button>
        <button class="secondary" onclick="showAllRecords()">显示全部</button>
        <div class="table-container">
            <table id="recordsTable">
                <thead>
                    <tr>
                        <th>日期</th>
                        <th>操作类型</th>
                        <th>物品名称</th>
                        <th>数量</th>
                        <th>单价</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    
    <div id="sellPanel" class="panel">
        <div class="message" id="sellMessage"></div>
        <div class="form-group">
            <label for="sellItemName">物品名称</label>
            <input type="text" id="sellItemName" placeholder="请输入物品名称">
            <small>提示：输入后可选择从库存中扣除</small>
        </div>
        <div class="form-group">
            <label for="sellQuantity">数量</label>
            <input type="number" id="sellQuantity" min="1" placeholder="请输入数量">
        </div>
        <div class="form-group">
            <label for="sellOriginalPrice">物品原价 (¥)</label>
            <input type="number" id="sellOriginalPrice" min="0" step="0.01" placeholder="请输入物品原价">
        </div>
        <div class="form-group">
            <label for="sellPrice">售卖单价 (¥)</label>
            <input type="number" id="sellPrice" min="0" step="0.01" placeholder="请输入售卖单价">
        </div>
        <div class="form-group">
            <label for="sellFromInventory">
                <input type="checkbox" id="sellFromInventory"> 从库存中扣除
            </label>
        </div>
        <button onclick="addSellItem()">确认售卖</button>
    </div>
    
    <div id="sellRecordsPanel" class="panel">
        <div class="message" id="sellRecordsMessage"></div>
        <div class="form-group">
            <label for="sellRecordDate">筛选日期</label>
            <input type="date" id="sellRecordDate">
        </div>
        <button onclick="filterSellRecords()">筛选</button>
        <button class="secondary" onclick="showAllSellRecords()">显示全部</button>
        <div class="total-stats">
            <p>总销量: <span id="totalSellQuantity">0</span></p>
            <p>总价（原价）: ¥<span id="totalOriginalAmount">0.00</span></p>
            <p>总销售额（现价）: ¥<span id="totalSellAmount">0.00</span></p>
            <p>总盈利: ¥<span id="totalProfit">0.00</span></p>
        </div>
        <div class="table-container">
            <table id="sellRecordsTable">
                <thead>
                    <tr>
                        <th>日期</th>
                        <th>物品名称</th>
                        <th>数量</th>
                        <th>原价</th>
                        <th>现价</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    
    <div id="syncPanel" class="panel">
        <div class="message" id="syncMessage"></div>
        <h3 style="text-align: center; margin-bottom: 15px;">数据同步</h3>
        <div class="import-export-buttons">
            <button onclick="exportData()">导出数据</button>
            <button onclick="triggerImport()">导入数据</button>
        </div>
        <input type="file" id="fileInput" style="display: none;" accept=".json">
        <div id="qrCodeContainer" class="qr-code-container"></div>
    </div>
    
    <script>
        // 初始化数据存储
        window.inventory = window.inventory || {};
        window.importExportRecords = window.importExportRecords || [];
        window.sellRecords = window.sellRecords || [];
        
        // 尝试从localStorage加载数据，如果失败则使用默认值
        function loadData() {
            try {
                const savedInventory = localStorage.getItem('inventory');
                const savedRecords = localStorage.getItem('importExportRecords');
                const savedSellRecords = localStorage.getItem('sellRecords');
                
                if (savedInventory) {
                    window.inventory = JSON.parse(savedInventory);
                }
                if (savedRecords) {
                    window.importExportRecords = JSON.parse(savedRecords);
                }
                if (savedSellRecords) {
                    window.sellRecords = JSON.parse(savedSellRecords);
                }
            } catch (e) {
                console.error('加载数据失败:', e);
                // 使用默认值
                window.inventory = {};
                window.importExportRecords = [];
                window.sellRecords = [];
            }
        }
        
        // 保存数据到localStorage
        function saveData() {
            try {
                localStorage.setItem('inventory', JSON.stringify(window.inventory));
                localStorage.setItem('importExportRecords', JSON.stringify(window.importExportRecords));
                localStorage.setItem('sellRecords', JSON.stringify(window.sellRecords));
            } catch (e) {
                console.error('保存数据失败:', e);
            }
        }
        
        // 切换标签页
        window.switchTab = function(tabName) {
            // 隐藏所有面板
            const panels = document.querySelectorAll('.panel');
            panels.forEach(panel => panel.classList.remove('active'));
            
            // 移除所有标签的活跃状态
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // 显示选中的面板和标签
            document.getElementById(tabName + 'Panel').classList.add('active');
            
            // 为当前选中的标签添加活跃状态
            tabs.forEach(tab => {
                if (tab.getAttribute('onclick') === `switchTab('${tabName}')`) {
                    tab.classList.add('active');
                }
            });
            
            // 更新显示
            if (tabName === 'inventory') {
                updateInventoryDisplay();
            } else if (tabName === 'export') {
                updateExportItemList();
            } else if (tabName === 'records') {
                showAllRecords();
            } else if (tabName === 'sellRecords') {
                showAllSellRecords();
            }
        };
        
        // 显示消息
        function showMessage(panelId, message, isSuccess = true) {
            const messageElement = document.getElementById(panelId + 'Message');
            messageElement.textContent = message;
            messageElement.className = 'message ' + (isSuccess ? 'success' : 'error');
            
            // 3秒后隐藏消息
            setTimeout(() => {
                messageElement.className = 'message';
            }, 3000);
        }
        
        // 添加库存物品（入库）
        window.addInventoryItem = function() {
            const name = document.getElementById('importName').value.trim();
            const quantity = parseInt(document.getElementById('importQuantity').value);
            const price = parseFloat(document.getElementById('importPrice').value);
            
            if (!name) {
                showMessage('import', '请输入物品名称', false);
                return;
            }
            
            if (isNaN(quantity) || quantity <= 0) {
                showMessage('import', '请输入有效的数量', false);
                return;
            }
            
            if (isNaN(price) || price < 0) {
                showMessage('import', '请输入有效的单价', false);
                return;
            }
            
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const timeStr = now.toTimeString().split(' ')[0];
            
            // 更新库存
            if (window.inventory[name]) {
                // 如果物品已存在，按加权平均更新单价
                const totalValue = window.inventory[name].quantity * window.inventory[name].price + quantity * price;
                const totalQuantity = window.inventory[name].quantity + quantity;
                window.inventory[name] = {
                    name: name,
                    quantity: totalQuantity,
                    price: totalValue / totalQuantity
                };
            } else {
                // 新增物品
                window.inventory[name] = {
                    name: name,
                    quantity: quantity,
                    price: price
                };
            }
            
            // 添加入库记录
            window.importExportRecords.push({
                id: Date.now(),
                date: dateStr,
                time: timeStr,
                type: '入库',
                name: name,
                quantity: quantity,
                price: price
            });
            
            saveData();
            updateInventoryDisplay();
            updateExportItemList();
            
            // 清空表单
            document.getElementById('importName').value = '';
            document.getElementById('importQuantity').value = '';
            document.getElementById('importPrice').value = '';
            
            showMessage('import', '物品入库成功');
        };
        
        // 移除库存物品（出库）
        window.removeInventoryItem = function() {
            const name = document.getElementById('exportName').value;
            const quantity = parseInt(document.getElementById('exportQuantity').value);
            
            if (!name) {
                showMessage('export', '请选择物品', false);
                return;
            }
            
            if (isNaN(quantity) || quantity <= 0) {
                showMessage('export', '请输入有效的数量', false);
                return;
            }
            
            if (!window.inventory[name] || window.inventory[name].quantity < quantity) {
                showMessage('export', '库存不足', false);
                return;
            }
            
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const timeStr = now.toTimeString().split(' ')[0];
            
            // 更新库存
            const item = window.inventory[name];
            item.quantity -= quantity;
            
            if (item.quantity === 0) {
                delete window.inventory[name];
            }
            
            // 添加出库记录
            window.importExportRecords.push({
                id: Date.now(),
                date: dateStr,
                time: timeStr,
                type: '出库',
                name: name,
                quantity: quantity,
                price: item.price
            });
            
            saveData();
            updateInventoryDisplay();
            updateExportItemList();
            
            // 清空表单
            document.getElementById('exportQuantity').value = '';
            
            showMessage('export', '物品出库成功');
        };
        
        // 更新库存显示
        function updateInventoryDisplay() {
            const tableBody = document.getElementById('inventoryTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';
            
            let totalItems = 0;
            let totalValue = 0;
            
            for (const name in window.inventory) {
                const item = window.inventory[name];
                const total = item.quantity * item.price;
                
                totalItems += item.quantity;
                totalValue += total;
                
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>
                        <input type="number" min="0" class="quantity-input" value="${item.quantity}" onchange="updateItemQuantity('${item.name}', this.value)">
                    </td>
                    <td>
                        <input type="number" min="0" step="0.01" class="price-input" value="${item.price.toFixed(2)}" onchange="updateItemPrice('${item.name}', this.value)">
                    </td>
                    <td>¥${total.toFixed(2)}</td>
                    <td class="item-actions">
                        <button class="danger" onclick="deleteInventoryItem('${item.name}')">删除</button>
                    </td>
                `;
            }
            
            // 更新统计信息
            document.getElementById('totalItems').textContent = totalItems;
            document.getElementById('totalValue').textContent = totalValue.toFixed(2);
        }
        
        // 更新物品数量
        window.updateItemQuantity = function(name, newQuantity) {
            const quantity = parseInt(newQuantity);
            
            if (isNaN(quantity) || quantity < 0) {
                showMessage('inventory', '请输入有效的数量', false);
                updateInventoryDisplay(); // 恢复原值
                return;
            }
            
            const oldQuantity = window.inventory[name].quantity;
            const difference = quantity - oldQuantity;
            
            if (difference === 0) return;
            
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const timeStr = now.toTimeString().split(' ')[0];
            
            // 更新库存
            window.inventory[name].quantity = quantity;
            
            if (quantity === 0) {
                delete window.inventory[name];
            }
            
            // 添加记录
            window.importExportRecords.push({
                id: Date.now(),
                date: dateStr,
                time: timeStr,
                type: difference > 0 ? '入库' : '出库',
                name: name,
                quantity: Math.abs(difference),
                price: window.inventory[name]?.price || 0,
                note: '数量调整'
            });
            
            saveData();
            updateInventoryDisplay();
            updateExportItemList();
            
            showMessage('inventory', '数量更新成功');
        };
        
        // 更新物品单价
        window.updateItemPrice = function(name, newPrice) {
            const price = parseFloat(newPrice);
            
            if (isNaN(price) || price < 0) {
                showMessage('inventory', '请输入有效的单价', false);
                updateInventoryDisplay(); // 恢复原值
                return;
            }
            
            const oldPrice = window.inventory[name].price;
            
            if (oldPrice === price) return;
            
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const timeStr = now.toTimeString().split(' ')[0];
            
            // 更新库存
            window.inventory[name].price = price;
            
            // 添加记录
            window.importExportRecords.push({
                id: Date.now(),
                date: dateStr,
                time: timeStr,
                type: '单价调整',
                name: name,
                quantity: 0,
                price: price,
                note: `单价从 ${oldPrice.toFixed(2)} 调整为 ${price.toFixed(2)}`
            });
            
            saveData();
            updateInventoryDisplay();
            
            showMessage('inventory', '单价更新成功');
        };
        
        // 删除库存物品
        window.deleteInventoryItem = function(name) {
            if (!confirm(`确定要删除物品 "${name}" 吗？`)) return;
            
            const item = window.inventory[name];
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const timeStr = now.toTimeString().split(' ')[0];
            
            // 添加记录
            window.importExportRecords.push({
                id: Date.now(),
                date: dateStr,
                time: timeStr,
                type: '删除',
                name: name,
                quantity: item.quantity,
                price: item.price,
                note: '删除物品'
            });
            
            // 删除库存
            delete window.inventory[name];
            
            saveData();
            updateInventoryDisplay();
            updateExportItemList();
            
            showMessage('inventory', '物品删除成功');
        };
        
        // 更新出库物品列表
        function updateExportItemList() {
            const select = document.getElementById('exportName');
            select.innerHTML = '';
            
            for (const name in window.inventory) {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = `${name} (库存: ${window.inventory[name].quantity})`;
                select.appendChild(option);
            }
        }
        
        // 显示所有出入库记录
        window.showAllRecords = function() {
            document.getElementById('recordDate').value = '';
            displayRecords(window.importExportRecords);
        };
        
        // 筛选出入库记录
        window.filterRecords = function() {
            const date = document.getElementById('recordDate').value;
            
            if (!date) {
                showMessage('records', '请选择日期', false);
                return;
            }
            
            const filteredRecords = window.importExportRecords.filter(record => record.date === date);
            displayRecords(filteredRecords);
        };
        
        // 显示出入库记录
        function displayRecords(records) {
            const tableBody = document.getElementById('recordsTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';
            
            // 按日期和时间排序（最新的在前）
            records.sort((a, b) => {
                const dateComparison = b.date.localeCompare(a.date);
                if (dateComparison !== 0) return dateComparison;
                return b.time.localeCompare(a.time);
            });
            
            records.forEach(record => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${record.date} ${record.time}</td>
                    <td>${record.type}</td>
                    <td>${record.name}</td>
                    <td>${record.quantity || ''}</td>
                    <td>${record.price ? '¥' + record.price.toFixed(2) : ''}</td>
                    <td class="item-actions">
                        <button class="danger" onclick="deleteRecord(${record.id})")>删除</button>
                    </td>
                `;
            });
        }
        
        // 删除出入库记录
        window.deleteRecord = function(id) {
            if (!confirm('确定要删除这条记录吗？删除后将无法恢复。')) return;
            
            // 从记录列表中移除
            const index = window.importExportRecords.findIndex(record => record.id === id);
            if (index !== -1) {
                window.importExportRecords.splice(index, 1);
                saveData();
                showAllRecords();
                showMessage('records', '记录删除成功');
            }
        };
        
        // 添加售卖记录
        window.addSellItem = function() {
            const name = document.getElementById('sellItemName').value.trim();
            const quantity = parseInt(document.getElementById('sellQuantity').value);
            const originalPrice = parseFloat(document.getElementById('sellOriginalPrice').value);
            const sellPrice = parseFloat(document.getElementById('sellPrice').value);
            const fromInventory = document.getElementById('sellFromInventory').checked;
            
            if (!name) {
                showMessage('sell', '请输入物品名称', false);
                return;
            }
            
            if (isNaN(quantity) || quantity <= 0) {
                showMessage('sell', '请输入有效的数量', false);
                return;
            }
            
            if (isNaN(originalPrice) || originalPrice < 0) {
                showMessage('sell', '请输入有效的物品原价', false);
                return;
            }
            
            if (isNaN(sellPrice) || sellPrice < 0) {
                showMessage('sell', '请输入有效的售卖单价', false);
                return;
            }
            
            // 如果选择从库存扣除，检查库存
            if (fromInventory) {
                if (!window.inventory[name] || window.inventory[name].quantity < quantity) {
                    showMessage('sell', '库存不足', false);
                    return;
                }
            }
            
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const timeStr = now.toTimeString().split(' ')[0];
            
            // 如果选择从库存扣除，更新库存
            if (fromInventory) {
                const item = window.inventory[name];
                item.quantity -= quantity;
                
                if (item.quantity === 0) {
                    delete window.inventory[name];
                }
                
                // 添加出库记录
                window.importExportRecords.push({
                    id: Date.now(),
                    date: dateStr,
                    time: timeStr,
                    type: '出库',
                    name: name,
                    quantity: quantity,
                    price: item.price,
                    note: '售卖出库'
                });
            }
            
            // 添加售卖记录
            window.sellRecords.push({
                id: Date.now(),
                date: dateStr,
                time: timeStr,
                name: name,
                quantity: quantity,
                originalPrice: originalPrice,
                sellPrice: sellPrice,
                fromInventory: fromInventory
            });
            
            saveData();
            updateInventoryDisplay();
            updateExportItemList();
            
            // 清空表单
            document.getElementById('sellItemName').value = '';
            document.getElementById('sellQuantity').value = '';
            document.getElementById('sellOriginalPrice').value = '';
            document.getElementById('sellPrice').value = '';
            
            showMessage('sell', '售卖记录添加成功');
        };
        
        // 显示所有售卖记录
        window.showAllSellRecords = function() {
            document.getElementById('sellRecordDate').value = '';
            displaySellRecords(window.sellRecords);
        };
        
        // 筛选售卖记录
        window.filterSellRecords = function() {
            const date = document.getElementById('sellRecordDate').value;
            
            if (!date) {
                showMessage('sellRecords', '请选择日期', false);
                return;
            }
            
            const filteredRecords = window.sellRecords.filter(record => record.date === date);
            displaySellRecords(filteredRecords);
        };
        
        // 显示售卖记录
        function displaySellRecords(records) {
            const tableBody = document.getElementById('sellRecordsTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';
            
            let totalQuantity = 0;
            let totalOriginalAmount = 0;
            let totalSellAmount = 0;
            let totalProfit = 0;
            
            // 按日期和时间排序（最新的在前）
            records.sort((a, b) => {
                const dateComparison = b.date.localeCompare(a.date);
                if (dateComparison !== 0) return dateComparison;
                return b.time.localeCompare(a.time);
            });
            
            records.forEach(record => {
                const originalAmount = record.quantity * record.originalPrice;
                const sellAmount = record.quantity * record.sellPrice;
                const profit = sellAmount - originalAmount;
                
                totalQuantity += record.quantity;
                totalOriginalAmount += originalAmount;
                totalSellAmount += sellAmount;
                totalProfit += profit;
                
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${record.date} ${record.time}</td>
                    <td>${record.name}</td>
                    <td>${record.quantity}</td>
                    <td>
                        <input type="number" min="0" step="0.01" class="price-input" value="${record.originalPrice.toFixed(2)}" onchange="updateSellRecordOriginalPrice(${record.id}, this.value)">
                    </td>
                    <td>
                        <input type="number" min="0" step="0.01" class="price-input" value="${record.sellPrice.toFixed(2)}" onchange="updateSellRecordSellPrice(${record.id}, this.value)">
                    </td>
                    <td class="item-actions">
                        <button class="danger" onclick="deleteSellRecord(${record.id})")>删除</button>
                    </td>
                `;
            });
            
            // 更新统计信息
            document.getElementById('totalSellQuantity').textContent = totalQuantity;
            document.getElementById('totalOriginalAmount').textContent = totalOriginalAmount.toFixed(2);
            document.getElementById('totalSellAmount').textContent = totalSellAmount.toFixed(2);
            
            const profitElement = document.getElementById('totalProfit');
            profitElement.textContent = totalProfit.toFixed(2);
            // 根据盈亏设置不同颜色
            if (totalProfit > 0) {
                profitElement.className = 'profit';
            } else if (totalProfit < 0) {
                profitElement.className = 'loss';
            } else {
                profitElement.className = '';
            }
        }
        
        // 更新售卖记录的物品原价
        window.updateSellRecordOriginalPrice = function(id, newPrice) {
            const price = parseFloat(newPrice);
            
            if (isNaN(price) || price < 0) {
                showMessage('sellRecords', '请输入有效的原价', false);
                showAllSellRecords(); // 恢复原值
                return;
            }
            
            const record = window.sellRecords.find(r => r.id === id);
            if (record) {
                record.originalPrice = price;
                saveData();
                showAllSellRecords();
                showMessage('sellRecords', '原价更新成功');
            }
        };
        
        // 更新售卖记录的售卖单价
        window.updateSellRecordSellPrice = function(id, newPrice) {
            const price = parseFloat(newPrice);
            
            if (isNaN(price) || price < 0) {
                showMessage('sellRecords', '请输入有效的售卖单价', false);
                showAllSellRecords(); // 恢复原值
                return;
            }
            
            const record = window.sellRecords.find(r => r.id === id);
            if (record) {
                record.sellPrice = price;
                saveData();
                showAllSellRecords();
                showMessage('sellRecords', '售卖单价更新成功');
            }
        };
        
        // 删除售卖记录
        window.deleteSellRecord = function(id) {
            if (!confirm('确定要删除这条售卖记录吗？')) return;
            
            // 从记录列表中移除
            const index = window.sellRecords.findIndex(record => record.id === id);
            if (index !== -1) {
                const record = window.sellRecords[index];
                
                // 如果该记录关联了库存物品出库，提供选项恢复库存
                if (record.fromInventory) {
                    if (confirm('是否同时恢复相关库存？')) {
                        // 恢复库存
                        if (window.inventory[record.name]) {
                            window.inventory[record.name].quantity += record.quantity;
                        } else {
                            // 如果物品已不存在，使用记录中的原价
                            window.inventory[record.name] = {
                                name: record.name,
                                quantity: record.quantity,
                                price: record.originalPrice
                            };
                        }
                        
                        // 找到并删除对应的出库记录
                        const exportIndex = window.importExportRecords.findIndex(r => 
                            r.date === record.date && 
                            r.time === record.time && 
                            r.type === '出库' && 
                            r.name === record.name && 
                            r.quantity === record.quantity &&
                            r.note === '售卖出库'
                        );
                        
                        if (exportIndex !== -1) {
                            window.importExportRecords.splice(exportIndex, 1);
                        }
                    }
                }
                
                window.sellRecords.splice(index, 1);
                saveData();
                updateInventoryDisplay();
                updateExportItemList();
                showAllSellRecords();
                showMessage('sellRecords', '售卖记录删除成功');
            }
        };
        
        // 导出数据
        window.exportData = function() {
            const data = {
                inventory: window.inventory,
                importExportRecords: window.importExportRecords,
                sellRecords: window.sellRecords
            };
            
            const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `inventory-data-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage('sync', '数据导出成功');
        };
        
        // 触发文件导入
        window.triggerImport = function() {
            document.getElementById('fileInput').click();
        };
        
        // 监听文件选择
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const data = JSON.parse(event.target.result);
                    
                    if (confirm('导入数据将覆盖现有数据，确定继续吗？')) {
                        window.inventory = data.inventory || {};
                        window.importExportRecords = data.importExportRecords || [];
                        window.sellRecords = data.sellRecords || [];
                        
                        saveData();
                        updateInventoryDisplay();
                        updateExportItemList();
                        showAllRecords();
                        showAllSellRecords();
                        
                        showMessage('sync', '数据导入成功');
                    }
                } catch (error) {
                    showMessage('sync', '数据格式错误，导入失败', false);
                }
            };
            
            reader.readAsText(file);
            
            // 重置文件输入，允许重复选择同一文件
            this.value = '';
        });
        
        // 初始化
        function init() {
            loadData();
            updateInventoryDisplay();
            updateExportItemList();
            showAllRecords();
            showAllSellRecords();
        }
        
        // 页面加载完成后初始化
        window.onload = init;
    </script>
</body>
</html>