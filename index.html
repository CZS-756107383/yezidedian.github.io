<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>库存管理系统</title>
    <style>
        /* 基础样式 */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 10px;
            box-sizing: border-box;
        }

        h1 {
            text-align: center;
            color: #07c160;
            font-size: 24px;
            margin-top: 10px;
            margin-bottom: 20px;
        }

        /* 标签页样式 */
        .tabs {
            display: flex;
            background-color: #fff;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 12px 5px;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            position: relative;
            transition: all 0.3s;
            -webkit-tap-highlight-color: transparent;
        }

        .tab.active {
            color: #07c160;
            font-weight: bold;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 3px;
            background-color: #07c160;
            border-radius: 1.5px;
        }

        /* 内容面板样式 */
        .panel {
            display: none;
            background-color: #fff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .panel.active {
            display: block;
        }

        /* 表单样式 */
        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #666;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
            outline: none;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus,
        select:focus {
            border-color: #07c160;
        }

        /* 按钮样式 */
        button {
            width: 100%;
            padding: 12px;
            background-color: #07c160;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
            -webkit-tap-highlight-color: transparent;
        }

        button:active {
            background-color: #06b156;
        }

        .button-secondary {
            background-color: #fff;
            color: #07c160;
            border: 1px solid #07c160;
            margin-top: 10px;
        }

        .button-secondary:active {
            background-color: #f5f5f5;
        }

        /* 表格样式 */
        .table-container {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
            border: 1px solid #eee;
            border-radius: 4px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        th,
        td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: #f9f9f9;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        tr:last-child td {
            border-bottom: none;
        }

        /* 空状态样式 */
        .empty-state {
            text-align: center;
            padding: 30px;
            color: #999;
        }

        /* 统计信息样式 */
        .stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }

        .stat-item {
            text-align: center;
            flex: 1;
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #07c160;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        /* 筛选器样式 */
        .filter {
            display: flex;
            margin-bottom: 15px;
            gap: 10px;
            align-items: center;
        }

        .filter input,
        .filter select {
            flex: 1;
            padding: 8px;
        }

        .filter button {
            padding: 8px 15px;
            width: auto;
        }

        /* 操作按钮样式 */
        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .btn-delete {
            background-color: #ff4757;
            padding: 5px 10px;
            font-size: 12px;
        }

        /* 响应式优化 */
        @media (max-width: 480px) {
            .tab {
                font-size: 13px;
                padding: 10px 3px;
            }

            .panel {
                padding: 10px;
            }
        }

        /* 加载提示 */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #07c160;
        }

        /* 确认对话框样式 */
        .confirm-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .confirm-dialog-content {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            width: 80%;
            max-width: 400px;
        }

        .confirm-dialog-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }

        .confirm-dialog-message {
            margin-bottom: 20px;
            text-align: center;
        }

        .confirm-dialog-options {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }

        .confirm-dialog-button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
        }

        .confirm-dialog-button.cancel {
            background-color: #f1f1f1;
            color: #666;
        }

        .confirm-dialog-button.confirm {
            background-color: #07c160;
            color: white;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .checkbox-container input[type="checkbox"] {
            margin-right: 10px;
            width: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>库存管理系统</h1>
        
        <!-- 标签页 -->
        <div class="tabs">
            <div class="tab active" onclick="window.switchTab('stockIn')">物品入库</div>
            <div class="tab" onclick="window.switchTab('stockOut')">物品出库</div>
            <div class="tab" onclick="window.switchTab('currentStock')">当前库存</div>
            <div class="tab" onclick="window.switchTab('records')">出入库记录</div>
        </div>

        <!-- 物品入库面板 -->
        <div id="stockInPanel" class="panel active">
            <div class="form-group">
                <label for="stockInName">物品名称</label>
                <input type="text" id="stockInName" placeholder="请输入物品名称">
            </div>
            <div class="form-group">
                <label for="stockInQuantity">入库数量</label>
                <input type="number" id="stockInQuantity" placeholder="请输入入库数量" min="1">
            </div>
            <div class="form-group">
                <label for="stockInPrice">单价</label>
                <input type="number" id="stockInPrice" placeholder="请输入单价" min="0" step="0.01">
            </div>
            <div class="form-group">
                <label for="stockInDate">入库日期</label>
                <input type="date" id="stockInDate">
            </div>
            <button onclick="window.addStockIn()">确认入库</button>
        </div>

        <!-- 物品出库面板 -->
        <div id="stockOutPanel" class="panel">
            <div class="form-group">
                <label for="stockOutName">物品名称</label>
                <input type="text" id="stockOutName" placeholder="请输入物品名称">
            </div>
            <div class="form-group">
                <label for="stockOutQuantity">出库数量</label>
                <input type="number" id="stockOutQuantity" placeholder="请输入出库数量" min="1">
            </div>
            <div class="form-group">
                <label for="stockOutDate">出库日期</label>
                <input type="date" id="stockOutDate">
            </div>
            <button onclick="window.addStockOut()">确认出库</button>
        </div>

        <!-- 当前库存面板 -->
        <div id="currentStockPanel" class="panel">
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-value" id="totalItems">0</div>
                    <div class="stat-label">物品种类</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalQuantity">0</div>
                    <div class="stat-label">总数量</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalValue">¥0</div>
                    <div class="stat-label">总价值</div>
                </div>
            </div>
            <div class="table-container">
                <table id="stockTable">
                    <thead>
                        <tr>
                            <th>物品名称</th>
                            <th>库存数量</th>
                            <th>单价</th>
                            <th>总价值</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- 出入库记录面板 -->
        <div id="recordsPanel" class="panel">
            <div class="filter">
                <input type="date" id="recordDateFilter" placeholder="选择日期">
                <select id="recordTypeFilter">
                    <option value="all">全部类型</option>
                    <option value="in">入库</option>
                    <option value="out">出库</option>
                </select>
                <button onclick="window.filterRecords()">筛选</button>
            </div>
            <div class="table-container">
                <table id="recordsTable">
                    <thead>
                        <tr>
                            <th>物品名称</th>
                            <th>操作类型</th>
                            <th>数量</th>
                            <th>日期</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <button class="button-secondary" onclick="window.deleteRecordsByDate()">按日期删除记录</button>
        </div>

        <!-- 物品售卖面板 -->
        <div class="tabs" style="margin-top: 20px;">
            <div class="tab" onclick="window.switchTab('sellItem')">物品售卖</div>
            <div class="tab" onclick="window.switchTab('sellRecords')">售卖记录</div>
            <div class="tab" onclick="window.switchTab('sync')">数据同步</div>
        </div>

        <!-- 物品售卖面板 -->
        <div id="sellItemPanel" class="panel">
            <div class="form-group">
                <label for="sellName">物品名称</label>
                <input type="text" id="sellName" placeholder="请输入物品名称">
            </div>
            <div class="form-group">
                <label for="sellQuantity">售卖数量</label>
                <input type="number" id="sellQuantity" placeholder="请输入售卖数量" min="1">
            </div>
            <div class="form-group">
                <label for="sellPrice">售卖单价</label>
                <input type="number" id="sellPrice" placeholder="请输入售卖单价" min="0" step="0.01">
            </div>
            <div class="form-group">
                <label for="sellDate">售卖日期</label>
                <input type="date" id="sellDate">
            </div>
            <button onclick="window.addSellItem()">确认售卖</button>
        </div>

        <!-- 售卖记录面板 -->
        <div id="sellRecordsPanel" class="panel">
            <div class="filter">
                <input type="date" id="sellRecordDateFilter" placeholder="选择日期">
                <button onclick="window.filterSellRecords()">筛选</button>
            </div>
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-value" id="totalSellQuantity">0</div>
                    <div class="stat-label">总销量</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalSellAmount">¥0</div>
                    <div class="stat-label">总销售额</div>
                </div>
            </div>
            <div class="table-container">
                <table id="sellRecordsTable">
                    <thead>
                        <tr>
                            <th>物品名称</th>
                            <th>数量</th>
                            <th>单价</th>
                            <th>金额</th>
                            <th>日期</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <button class="button-secondary" onclick="window.deleteSellRecordsByDate()">按日期删除售卖记录</button>
        </div>

        <!-- 数据同步面板 -->
        <div id="syncPanel" class="panel">
            <button onclick="window.exportData()">导出数据</button>
            <button class="button-secondary" onclick="window.importData()">导入数据</button>
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="window.handleFileImport(event)">
            <button class="button-secondary" onclick="window.generateQRCode()">生成分享二维码</button>
            <div id="qrcode" style="margin-top: 20px; text-align: center;"></div>
        </div>
    </div>

    <!-- 确认对话框模板 -->
    <div id="deleteConfirmDialog" class="confirm-dialog" style="display: none;">
        <div class="confirm-dialog-content">
            <div class="confirm-dialog-title">确认删除</div>
            <div class="confirm-dialog-message">确定要删除这条记录吗？删除后将无法恢复。</div>
            <div class="checkbox-container">
                <input type="checkbox" id="restoreInventoryCheckbox" checked>
                <label for="restoreInventoryCheckbox">同时恢复相关库存</label>
            </div>
            <div class="confirm-dialog-options">
                <button class="confirm-dialog-button cancel" onclick="window.hideDeleteDialog()">取消</button>
                <button class="confirm-dialog-button confirm" onclick="window.confirmDelete()">确定</button>
            </div>
        </div>
    </div>

    <script>
        // 当前待删除的记录ID
        window.currentDeleteRecordId = null;
        window.currentDeleteDate = null;
        window.deleteMode = null; // 'single' 或 'batch'

        // 初始化数据存储
        window.initStorage = function() {
            try {
                // 检查localStorage是否可用
                if (typeof localStorage !== 'undefined') {
                    window.storage = localStorage;
                } else {
                    // 使用内存存储作为降级方案
                    console.log('localStorage不可用，使用内存存储');
                    window.storage = {
                        data: {},
                        getItem: function(key) {
                            return this.data[key] || null;
                        },
                        setItem: function(key, value) {
                            this.data[key] = value;
                        },
                        removeItem: function(key) {
                            delete this.data[key];
                        }
                    };
                }

                // 初始化数据结构
                if (!window.storage.getItem('inventory')) {
                    window.storage.setItem('inventory', JSON.stringify({}));
                }
                if (!window.storage.getItem('records')) {
                    window.storage.setItem('records', JSON.stringify([]));
                }
                if (!window.storage.getItem('sellRecords')) {
                    window.storage.setItem('sellRecords', JSON.stringify([]));
                }
            } catch (error) {
                console.error('初始化存储失败:', error);
                // 强制使用内存存储
                window.storage = {
                    data: {
                        inventory: JSON.stringify({}),
                        records: JSON.stringify([]),
                        sellRecords: JSON.stringify([])
                    },
                    getItem: function(key) {
                        return this.data[key] || null;
                    },
                    setItem: function(key, value) {
                        this.data[key] = value;
                    },
                    removeItem: function(key) {
                        delete this.data[key];
                    }
                };
            }
        };

        // 标签页切换
        window.switchTab = function(tabId) {
            try {
                // 隐藏所有面板
                var panels = document.querySelectorAll('.panel');
                panels.forEach(function(panel) {
                    panel.classList.remove('active');
                });

                // 移除所有标签的活跃状态
                var tabs = document.querySelectorAll('.tab');
                tabs.forEach(function(tab) {
                    tab.classList.remove('active');
                });

                // 显示选中的面板
                var targetPanel = document.getElementById(tabId + 'Panel');
                if (targetPanel) {
                    targetPanel.classList.add('active');
                }

                // 高亮当前标签
                var activeTabButtons = document.querySelectorAll('.tab');
                activeTabButtons.forEach(function(button) {
                    if (button.getAttribute('onclick') === 'window.switchTab(\'' + tabId + '\')') {
                        button.classList.add('active');
                    }
                });

                // 更新当前库存面板
                if (tabId === 'currentStock') {
                    window.updateStockTable();
                }

                // 更新记录面板
                if (tabId === 'records') {
                    window.loadRecords();
                }

                // 更新售卖记录面板
                if (tabId === 'sellRecords') {
                    window.loadSellRecords();
                }
            } catch (error) {
                console.error('切换标签页失败:', error);
                alert('切换标签页失败，请重试');
            }
        };

        // 获取当前日期
        window.getCurrentDate = function() {
            var date = new Date();
            var year = date.getFullYear();
            var month = String(date.getMonth() + 1).padStart(2, '0');
            var day = String(date.getDate()).padStart(2, '0');
            return year + '-' + month + '-' + day;
        };

        // 初始化日期输入框
        window.initDateInputs = function() {
            try {
                document.getElementById('stockInDate').value = window.getCurrentDate();
                document.getElementById('stockOutDate').value = window.getCurrentDate();
                document.getElementById('sellDate').value = window.getCurrentDate();
            } catch (error) {
                console.error('初始化日期输入框失败:', error);
            }
        };

        // 添加入库记录
        window.addStockIn = function() {
            try {
                var name = document.getElementById('stockInName').value.trim();
                var quantity = parseInt(document.getElementById('stockInQuantity').value);
                var price = parseFloat(document.getElementById('stockInPrice').value);
                var date = document.getElementById('stockInDate').value;

                if (!name || isNaN(quantity) || quantity <= 0 || isNaN(price) || price < 0 || !date) {
                    alert('请填写所有必填字段且数值必须有效');
                    return;
                }

                // 获取当前库存
                var inventory = JSON.parse(window.storage.getItem('inventory'));
                var records = JSON.parse(window.storage.getItem('records'));

                // 更新库存
                if (inventory.hasOwnProperty(name)) {
                    // 计算新的平均单价
                    var totalValue = inventory[name].quantity * inventory[name].price + quantity * price;
                    var totalQuantity = inventory[name].quantity + quantity;
                    inventory[name] = {
                        quantity: totalQuantity,
                        price: totalValue / totalQuantity
                    };
                } else {
                    inventory[name] = {
                        quantity: quantity,
                        price: price
                    };
                }

                // 添加记录
                records.push({
                    id: new Date().getTime().toString(),
                    name: name,
                    type: 'in',
                    quantity: quantity,
                    price: price,
                    date: date
                });

                // 保存数据
                window.storage.setItem('inventory', JSON.stringify(inventory));
                window.storage.setItem('records', JSON.stringify(records));

                // 清空表单
                document.getElementById('stockInName').value = '';
                document.getElementById('stockInQuantity').value = '';
                document.getElementById('stockInPrice').value = '';

                alert('入库成功');
            } catch (error) {
                console.error('添加入库记录失败:', error);
                alert('入库失败，请重试');
            }
        };

        // 添加出库记录
        window.addStockOut = function() {
            try {
                var name = document.getElementById('stockOutName').value.trim();
                var quantity = parseInt(document.getElementById('stockOutQuantity').value);
                var date = document.getElementById('stockOutDate').value;

                if (!name || isNaN(quantity) || quantity <= 0 || !date) {
                    alert('请填写所有必填字段且数量必须有效');
                    return;
                }

                // 获取当前库存
                var inventory = JSON.parse(window.storage.getItem('inventory'));
                
                // 检查库存是否充足
                if (!inventory.hasOwnProperty(name) || inventory[name].quantity < quantity) {
                    alert('库存不足');
                    return;
                }

                // 更新库存
                inventory[name].quantity -= quantity;
                if (inventory[name].quantity === 0) {
                    delete inventory[name];
                }

                // 添加记录
                var records = JSON.parse(window.storage.getItem('records'));
                records.push({
                    id: new Date().getTime().toString(),
                    name: name,
                    type: 'out',
                    quantity: quantity,
                    price: inventory.hasOwnProperty(name) ? inventory[name].price : 0,
                    date: date
                });

                // 保存数据
                window.storage.setItem('inventory', JSON.stringify(inventory));
                window.storage.setItem('records', JSON.stringify(records));

                // 清空表单
                document.getElementById('stockOutName').value = '';
                document.getElementById('stockOutQuantity').value = '';

                alert('出库成功');
            } catch (error) {
                console.error('添加出库记录失败:', error);
                alert('出库失败，请重试');
            }
        };

        // 添加售卖记录 - 不影响库存
        window.addSellItem = function() {
            try {
                var name = document.getElementById('sellName').value.trim();
                var quantity = parseInt(document.getElementById('sellQuantity').value);
                var price = parseFloat(document.getElementById('sellPrice').value);
                var date = document.getElementById('sellDate').value;

                if (!name || isNaN(quantity) || quantity <= 0 || isNaN(price) || price < 0 || !date) {
                    alert('请填写所有必填字段且数值必须有效');
                    return;
                }

                // 获取售卖记录
                var sellRecords = JSON.parse(window.storage.getItem('sellRecords'));

                // 添加售卖记录
                sellRecords.push({
                    id: new Date().getTime().toString(),
                    name: name,
                    quantity: quantity,
                    price: price,
                    amount: quantity * price,
                    date: date
                });

                // 保存数据
                window.storage.setItem('sellRecords', JSON.stringify(sellRecords));

                // 清空表单
                document.getElementById('sellName').value = '';
                document.getElementById('sellQuantity').value = '';
                document.getElementById('sellPrice').value = '';

                alert('售卖记录添加成功');
            } catch (error) {
                console.error('添加售卖记录失败:', error);
                alert('添加售卖记录失败，请重试');
            }
        };

        // 更新库存表格
        window.updateStockTable = function() {
            try {
                var inventory = JSON.parse(window.storage.getItem('inventory'));
                var tableBody = document.querySelector('#stockTable tbody');
                tableBody.innerHTML = '';

                var totalItems = 0;
                var totalQuantity = 0;
                var totalValue = 0;

                for (var name in inventory) {
                    totalItems++;
                    totalQuantity += inventory[name].quantity;
                    var itemValue = inventory[name].quantity * inventory[name].price;
                    totalValue += itemValue;

                    var row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${name}</td>
                        <td>${inventory[name].quantity}</td>
                        <td>¥${inventory[name].price.toFixed(2)}</td>
                        <td>¥${itemValue.toFixed(2)}</td>
                    `;
                    tableBody.appendChild(row);
                }

                // 更新统计信息
                document.getElementById('totalItems').textContent = totalItems;
                document.getElementById('totalQuantity').textContent = totalQuantity;
                document.getElementById('totalValue').textContent = '¥' + totalValue.toFixed(2);

                // 处理空状态
                if (totalItems === 0) {
                    var emptyRow = document.createElement('tr');
                    emptyRow.innerHTML = '<td colspan="4" class="empty-state">暂无库存数据</td>';
                    tableBody.appendChild(emptyRow);
                }
            } catch (error) {
                console.error('更新库存表格失败:', error);
            }
        };

        // 加载出入库记录
        window.loadRecords = function(filterDate = '', filterType = 'all') {
            try {
                var records = JSON.parse(window.storage.getItem('records'));
                var filteredRecords = records;

                // 按日期筛选
                if (filterDate) {
                    filteredRecords = filteredRecords.filter(function(record) {
                        return record.date === filterDate;
                    });
                }

                // 按类型筛选
                if (filterType !== 'all') {
                    filteredRecords = filteredRecords.filter(function(record) {
                        return record.type === filterType;
                    });
                }

                // 按日期降序排序
                filteredRecords.sort(function(a, b) {
                    return new Date(b.date) - new Date(a.date);
                });

                var tableBody = document.querySelector('#recordsTable tbody');
                tableBody.innerHTML = '';

                filteredRecords.forEach(function(record) {
                    var typeText = record.type === 'in' ? '入库' : '出库';
                    var row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${record.name}</td>
                        <td>${typeText}</td>
                        <td>${record.quantity}</td>
                        <td>${record.date}</td>
                        <td class="action-buttons">
                            <button class="btn-delete" onclick="window.showDeleteDialog('${record.id}', 'single')">删除</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });

                // 处理空状态
                if (filteredRecords.length === 0) {
                    var emptyRow = document.createElement('tr');
                    emptyRow.innerHTML = '<td colspan="5" class="empty-state">暂无记录</td>';
                    tableBody.appendChild(emptyRow);
                }
            } catch (error) {
                console.error('加载出入库记录失败:', error);
            }
        };

        // 筛选出入库记录
        window.filterRecords = function() {
            var filterDate = document.getElementById('recordDateFilter').value;
            var filterType = document.getElementById('recordTypeFilter').value;
            window.loadRecords(filterDate, filterType);
        };

        // 加载售卖记录
        window.loadSellRecords = function(filterDate = '') {
            try {
                var sellRecords = JSON.parse(window.storage.getItem('sellRecords'));
                var filteredRecords = sellRecords;

                // 按日期筛选
                if (filterDate) {
                    filteredRecords = filteredRecords.filter(function(record) {
                        return record.date === filterDate;
                    });
                }

                // 按日期降序排序
                filteredRecords.sort(function(a, b) {
                    return new Date(b.date) - new Date(a.date);
                });

                var tableBody = document.querySelector('#sellRecordsTable tbody');
                tableBody.innerHTML = '';

                var totalSellQuantity = 0;
                var totalSellAmount = 0;

                filteredRecords.forEach(function(record) {
                    totalSellQuantity += record.quantity;
                    totalSellAmount += record.amount;

                    var row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${record.name}</td>
                        <td>${record.quantity}</td>
                        <td>¥${record.price.toFixed(2)}</td>
                        <td>¥${record.amount.toFixed(2)}</td>
                        <td>${record.date}</td>
                        <td class="action-buttons">
                            <button class="btn-delete" onclick="window.deleteSellRecord('${record.id}')">删除</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });

                // 更新统计信息
                document.getElementById('totalSellQuantity').textContent = totalSellQuantity;
                document.getElementById('totalSellAmount').textContent = '¥' + totalSellAmount.toFixed(2);

                // 处理空状态
                if (filteredRecords.length === 0) {
                    var emptyRow = document.createElement('tr');
                    emptyRow.innerHTML = '<td colspan="6" class="empty-state">暂无售卖记录</td>';
                    tableBody.appendChild(emptyRow);
                }
            } catch (error) {
                console.error('加载售卖记录失败:', error);
            }
        };

        // 筛选售卖记录
        window.filterSellRecords = function() {
            var filterDate = document.getElementById('sellRecordDateFilter').value;
            window.loadSellRecords(filterDate);
        };

        // 显示删除确认对话框
        window.showDeleteDialog = function(id, mode) {
            try {
                window.currentDeleteRecordId = id;
                window.deleteMode = mode;
                
                if (mode === 'batch') {
                    document.querySelector('#deleteConfirmDialog .confirm-dialog-message').textContent = 
                        '确定要删除所选日期的所有出入库记录吗？删除后将无法恢复。';
                } else {
                    document.querySelector('#deleteConfirmDialog .confirm-dialog-message').textContent = 
                        '确定要删除这条记录吗？删除后将无法恢复。';
                }
                
                // 默认选中恢复库存选项
                document.getElementById('restoreInventoryCheckbox').checked = true;
                document.getElementById('deleteConfirmDialog').style.display = 'flex';
            } catch (error) {
                console.error('显示删除对话框失败:', error);
                // 如果对话框显示失败，直接进行删除
                if (mode === 'batch') {
                    window.deleteRecordsByDateConfirm(false);
                } else {
                    window.deleteRecordConfirm(id, true);
                }
            }
        };

        // 隐藏删除确认对话框
        window.hideDeleteDialog = function() {
            document.getElementById('deleteConfirmDialog').style.display = 'none';
            window.currentDeleteRecordId = null;
            window.currentDeleteDate = null;
            window.deleteMode = null;
        };

        // 确认删除
        window.confirmDelete = function() {
            try {
                var restoreInventory = document.getElementById('restoreInventoryCheckbox').checked;
                
                if (window.deleteMode === 'batch') {
                    window.deleteRecordsByDateConfirm(restoreInventory);
                } else {
                    window.deleteRecordConfirm(window.currentDeleteRecordId, restoreInventory);
                }
                
                window.hideDeleteDialog();
            } catch (error) {
                console.error('确认删除失败:', error);
                window.hideDeleteDialog();
                alert('删除失败，请重试');
            }
        };

        // 删除单条出入库记录（带恢复库存选项）
        window.deleteRecordConfirm = function(recordId, restoreInventory) {
            try {
                var records = JSON.parse(window.storage.getItem('records'));
                var recordIndex = records.findIndex(function(record) {
                    return record.id === recordId;
                });

                if (recordIndex === -1) {
                    alert('记录不存在');
                    return;
                }

                var record = records[recordIndex];
                var inventory = JSON.parse(window.storage.getItem('inventory'));

                // 恢复库存（如果用户选择恢复）
                if (restoreInventory) {
                    if (record.type === 'in') {
                        // 如果是入库记录，减少库存
                        if (inventory.hasOwnProperty(record.name)) {
                            inventory[record.name].quantity -= record.quantity;
                            if (inventory[record.name].quantity <= 0) {
                                delete inventory[record.name];
                            }
                        }
                    } else if (record.type === 'out') {
                        // 如果是出库记录，增加库存
                        if (inventory.hasOwnProperty(record.name)) {
                            inventory[record.name].quantity += record.quantity;
                        } else {
                            inventory[record.name] = {
                                quantity: record.quantity,
                                price: record.price
                            };
                        }
                    }
                    // 保存更新后的库存
                    window.storage.setItem('inventory', JSON.stringify(inventory));
                }

                // 删除记录
                records.splice(recordIndex, 1);
                window.storage.setItem('records', JSON.stringify(records));

                // 刷新表格
                window.loadRecords();
                if (restoreInventory) {
                    window.updateStockTable();
                }

                alert('记录删除成功' + (restoreInventory ? '，库存已恢复' : ''));
            } catch (error) {
                console.error('删除记录失败:', error);
                alert('删除记录失败，请重试');
            }
        };

        // 删除单条出入库记录（兼容旧调用方式）
        window.deleteRecord = function(recordId) {
            window.showDeleteDialog(recordId, 'single');
        };

        // 删除单条售卖记录
        window.deleteSellRecord = function(recordId) {
            try {
                if (!confirm('确定要删除这条售卖记录吗？删除后将无法恢复。')) {
                    return;
                }

                var sellRecords = JSON.parse(window.storage.getItem('sellRecords'));
                var recordIndex = sellRecords.findIndex(function(record) {
                    return record.id === recordId;
                });

                if (recordIndex === -1) {
                    alert('记录不存在');
                    return;
                }

                // 删除记录
                sellRecords.splice(recordIndex, 1);

                // 保存数据
                window.storage.setItem('sellRecords', JSON.stringify(sellRecords));

                // 刷新表格
                window.loadSellRecords();

                alert('售卖记录删除成功');
            } catch (error) {
                console.error('删除售卖记录失败:', error);
                alert('删除售卖记录失败，请重试');
            }
        };

        // 按日期删除出入库记录（带恢复库存选项）
        window.deleteRecordsByDate = function() {
            try {
                var date = document.getElementById('recordDateFilter').value;
                if (!date) {
                    alert('请选择要删除的日期');
                    return;
                }

                // 检查该日期是否有记录
                var records = JSON.parse(window.storage.getItem('records'));
                var recordsToDelete = records.filter(function(record) {
                    return record.date === date;
                });

                if (recordsToDelete.length === 0) {
                    alert('该日期没有出入库记录');
                    return;
                }

                window.currentDeleteDate = date;
                window.showDeleteDialog(date, 'batch');
            } catch (error) {
                console.error('按日期删除记录失败:', error);
                alert('删除记录失败，请重试');
            }
        };

        // 按日期删除出入库记录确认
        window.deleteRecordsByDateConfirm = function(restoreInventory) {
            try {
                var date = window.currentDeleteDate;
                if (!date) {
                    alert('操作已取消');
                    return;
                }

                var records = JSON.parse(window.storage.getItem('records'));
                var recordsToDelete = records.filter(function(record) {
                    return record.date === date;
                });

                var inventory = JSON.parse(window.storage.getItem('inventory'));

                // 恢复库存（如果用户选择恢复）
                if (restoreInventory) {
                    recordsToDelete.forEach(function(record) {
                        if (record.type === 'in') {
                            // 如果是入库记录，减少库存
                            if (inventory.hasOwnProperty(record.name)) {
                                inventory[record.name].quantity -= record.quantity;
                                if (inventory[record.name].quantity <= 0) {
                                    delete inventory[record.name];
                                }
                            }
                        } else if (record.type === 'out') {
                            // 如果是出库记录，增加库存
                            if (inventory.hasOwnProperty(record.name)) {
                                inventory[record.name].quantity += record.quantity;
                            } else {
                                inventory[record.name] = {
                                    quantity: record.quantity,
                                    price: record.price
                                };
                            }
                        }
                    });
                    // 保存更新后的库存
                    window.storage.setItem('inventory', JSON.stringify(inventory));
                }

                // 过滤掉要删除的记录
                var remainingRecords = records.filter(function(record) {
                    return record.date !== date;
                });

                // 保存数据
                window.storage.setItem('records', JSON.stringify(remainingRecords));

                // 刷新表格
                window.loadRecords();
                if (restoreInventory) {
                    window.updateStockTable();
                }

                alert('已成功删除' + date + '的' + recordsToDelete.length + '条出入库记录' + 
                      (restoreInventory ? '，相关库存已恢复' : ''));
            } catch (error) {
                console.error('按日期删除出入库记录失败:', error);
                alert('删除记录失败，请重试');
            }
        };

        // 按日期删除售卖记录
        window.deleteSellRecordsByDate = function() {
            try {
                var date = document.getElementById('sellRecordDateFilter').value;
                if (!date) {
                    alert('请选择要删除的日期');
                    return;
                }

                if (!confirm('确定要删除' + date + '的所有售卖记录吗？删除后将无法恢复。')) {
                    return;
                }

                var sellRecords = JSON.parse(window.storage.getItem('sellRecords'));
                var recordsToDelete = sellRecords.filter(function(record) {
                    return record.date === date;
                });

                if (recordsToDelete.length === 0) {
                    alert('该日期没有售卖记录');
                    return;
                }

                // 过滤掉要删除的记录
                var remainingRecords = sellRecords.filter(function(record) {
                    return record.date !== date;
                });

                // 保存数据
                window.storage.setItem('sellRecords', JSON.stringify(remainingRecords));

                // 刷新表格
                window.loadSellRecords();

                alert('已成功删除' + date + '的' + recordsToDelete.length + '条售卖记录');
            } catch (error) {
                console.error('按日期删除售卖记录失败:', error);
                alert('删除记录失败，请重试');
            }
        };

        // 导出数据
        window.exportData = function() {
            try {
                var data = {
                    inventory: JSON.parse(window.storage.getItem('inventory')),
                    records: JSON.parse(window.storage.getItem('records')),
                    sellRecords: JSON.parse(window.storage.getItem('sellRecords')),
                    exportDate: new Date().toISOString()
                };

                var blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                var url = URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = 'inventory_data_' + new Date().toISOString().split('T')[0] + '.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                alert('数据导出成功');
            } catch (error) {
                console.error('导出数据失败:', error);
                alert('导出数据失败，请重试');
            }
        };

        // 导入数据
        window.importData = function() {
            document.getElementById('importFile').click();
        };

        // 处理文件导入
        window.handleFileImport = function(event) {
            try {
                var file = event.target.files[0];
                if (!file) {
                    return;
                }

                if (!file.name.endsWith('.json')) {
                    alert('请选择JSON格式的文件');
                    return;
                }

                var reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        var data = JSON.parse(e.target.result);

                        if (!data.inventory || !data.records || !data.sellRecords) {
                            alert('无效的数据文件格式');
                            return;
                        }

                        if (!confirm('确定要导入数据吗？当前数据将被覆盖。')) {
                            return;
                        }

                        // 保存导入的数据
                        window.storage.setItem('inventory', JSON.stringify(data.inventory));
                        window.storage.setItem('records', JSON.stringify(data.records));
                        window.storage.setItem('sellRecords', JSON.stringify(data.sellRecords));

                        // 刷新所有面板
                        window.updateStockTable();
                        window.loadRecords();
                        window.loadSellRecords();

                        alert('数据导入成功');
                    } catch (error) {
                        console.error('解析导入文件失败:', error);
                        alert('解析导入文件失败，请检查文件格式');
                    }
                };
                reader.readAsText(file);

                // 清空文件输入，允许重复导入同一文件
                event.target.value = '';
            } catch (error) {
                console.error('导入数据失败:', error);
                alert('导入数据失败，请重试');
            }
        };

        // 生成分享二维码
        window.generateQRCode = function() {
            try {
                var qrcodeContainer = document.getElementById('qrcode');
                qrcodeContainer.innerHTML = '<div class="loading">生成中...</div>';

                var data = {
                    inventory: JSON.parse(window.storage.getItem('inventory')),
                    records: JSON.parse(window.storage.getItem('records')),
                    sellRecords: JSON.parse(window.storage.getItem('sellRecords'))
                };

                // 将数据转换为Base64字符串
                var jsonStr = JSON.stringify(data);
                var base64Data = btoa(unescape(encodeURIComponent(jsonStr)));

                // 创建一个简单的分享页面URL (在实际使用中需要部署一个接收Base64数据的页面)
                var shareUrl = window.location.origin + window.location.pathname + '?data=' + base64Data;

                // 由于没有引入QRCode库，这里使用文本提示用户如何分享
                qrcodeContainer.innerHTML = `
                    <div style="padding: 10px; background-color: #f9f9f9; border-radius: 4px;">
                        <p>数据已准备好分享。由于安全限制，无法直接生成二维码。</p>
                        <p>请使用导出功能保存数据文件，然后在其他设备上导入。</p>
                    </div>
                `;
            } catch (error) {
                console.error('生成分享二维码失败:', error);
                document.getElementById('qrcode').innerHTML = '<p>生成分享二维码失败，请重试</p>';
            }
        };

        // 从URL参数加载数据
        window.loadDataFromUrl = function() {
            try {
                var urlParams = new URLSearchParams(window.location.search);
                var dataParam = urlParams.get('data');

                if (dataParam) {
                    if (confirm('检测到分享数据，是否导入？')) {
                        var jsonStr = decodeURIComponent(escape(atob(dataParam)));
                        var data = JSON.parse(jsonStr);

                        window.storage.setItem('inventory', JSON.stringify(data.inventory));
                        window.storage.setItem('records', JSON.stringify(data.records));
                        window.storage.setItem('sellRecords', JSON.stringify(data.sellRecords));

                        alert('数据导入成功');
                        window.location.search = ''; // 清除URL参数
                    }
                }
            } catch (error) {
                console.error('从URL加载数据失败:', error);
            }
        };

        // 初始化应用
        window.initApp = function() {
            try {
                window.initStorage();
                window.initDateInputs();
                window.loadDataFromUrl();
                
                // 初始加载当前库存和记录
                window.updateStockTable();
                window.loadRecords();
                window.loadSellRecords();
            } catch (error) {
                console.error('初始化应用失败:', error);
                alert('系统初始化失败，请刷新页面重试');
            }
        };

        // 页面加载完成后初始化应用
        window.onload = window.initApp;
    </script>
</body>
</html>